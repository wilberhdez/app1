// Copyright 2005-2014 Metrological
// All Rights Reserved.
(function(r,p,k,q){function u(c,e,f){c&&c.__defineGetter__(e,f)}function v(c){for(var e={},f;f=w.exec(c);)e[f[1]]=f[2];return e}var x=r.MAF=r.MAF={},m=RegExp,y=Error,w=/\??(.*?)=([^\&]*)&?/gi,z=function(c){var e=[m(/^https?:\/\/10.(\d{1,3}).(\d{1,3}).(\d{1,3}):?\d*$/),m(/^https?:\/\/172.(1[6-9]|2[0-9]|3[0-1]).(\d{1,3}).(\d{1,3}):?\d*$/),m(/^https?:\/\/192.168.(\d{1,3}).(\d{1,3}):?\d*$/),m(/^https?:\/\/localhost:?\d*$/)];a:{if(c)for(var f=0;f<e.length;f++)if(e[f].test(c)){c=!0;break a}c=!1}return c}(p&&
p.origin),A=v(k.location.search)||{},B=function(c){for(var e=0;e<c.length;e++){var f=(c[e].src||"").split("?");if(1<f.length&&m("maf-room.(min.js|js)").test(f[0]))return v(f[1])}}(k.getElementsByTagName("script"))||{};x.Room=function(){function c(a){this.events=this.events||{};if(!1!==a in this.events)for(var d=0;d<this.events[a].length;d++)this.events[a][d].apply(this,Array.prototype.slice.call(arguments,1))}function e(a){b&&1===b.readyState&&b.send(JSON.stringify(a))}function f(){s=!0;n=0;for(var a in h){var d=
h[a];d.user=q;c.call(d,"connected",{hash:a});var e=setInterval(function(){if(d.joined)return clearInterval(e);d.join()},3E3)}}function m(a){var d=JSON.parse(a.data),f=d.e;a=d.h;var b=d.u,k=d.d,l=h[a];if(l)switch(f){case "j":l.joined=!0;l.user||(l.user=b);g[a]=g[a]||[];-1===g[a].indexOf(b)&&(g[a].push(b),c.call(l,"joined",{hash:a,user:b,data:k}));l.user!==b&&e({e:"p",h:a,d:k});break;case "l":d=g[a].indexOf(b);-1<d&&(g[a].splice(d,1),c.call(l,"hasleft",{hash:a,user:b,data:k}));break;case "d":-1!==g[a].indexOf(b)&&
c.call(l,"data",{hash:a,user:b,data:k});break;case "p":-1===g[a].indexOf(b)&&(g[a].push(b),c.call(l,"joined",{hash:a,user:b,data:k}));break;case "e":c.call(l,"error",{hash:a,user:b,code:d.c})}}function p(){s=!1;n++;b&&(b.onopen=b.onmessage=b.onclose=null);b=null;for(var a in h){var d=h[a];d.joined=q;d.user=q;g[a].length=0}setTimeout(t,3E3*n)}function t(){var a;if(!(a=b))a:{try{a=new WebSocket("ws://ws"+(z?"-sdk":"")+".metrological.com/");break a}catch(d){}a=void 0}(b=a)?(b.onopen=f,b.onmessage=m,
b.onclose=p):(n++,setTimeout(t,3E3*n))}function k(a){a=a||A.hash||B.hash;if(!a)throw y("missing hash");if(h[a])return h[a];u(this,"hash",function(){return a});u(this,"connected",function(){return s});this.joined=!1;g[a]=[];h[a]=this}var n=0,s=!1,g={},h={},b;t();k.prototype={join:function(a){e({e:"j",h:this.hash,d:a})},leave:function(a){this.user=q;e({e:"l",h:this.hash,d:a})},send:function(a){e({e:"d",h:this.hash,d:a})},addEventListener:function(a,b){this.events=this.events||{};this.events[a]=this.events[a]||
[];this.events[a].push(b)},removeEventListener:function(a,b){this.events=this.events||{};if(!1!==a in this.events){var c=this.events[a].indexOf(b);-1<c&&this.events[a].splice(c,1)}},destroy:function(){if(h){this.leave();for(var a in this.events||{})this.events[a]&&(this.events[a].length=0),delete this.events[a];delete this.events;g[this.hash]&&(g[this.hash].length=0);delete g[this.hash];delete h[this.hash]}}};r.addEventListener("unload",function(){for(var a in h)h[a]&&h[a].destroy();h=g=null});return k}()})(window,
location,document);